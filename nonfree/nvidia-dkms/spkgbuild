# description	: NVIDIA Linux Display Driver - modules (long lived branch)
# depends	: dkms

name=nvidia-dkms
version=470.57.02
release=1
source="http://us.download.nvidia.com/XFree86/Linux-x86_64/$version/NVIDIA-Linux-x86_64-$version.run"

build() {
	sh NVIDIA-Linux-x86_64-$version.run --extract-only

	cd NVIDIA-Linux-x86_64-$version

	sed -i "s/__VERSION_STRING/$version/" kernel/dkms.conf
	sed -i 's/__JOBS/`nproc`/' kernel/dkms.conf
	sed -i 's/__DKMS_MODULES//' kernel/dkms.conf
	sed -i '$iBUILT_MODULE_NAME[0]="nvidia"\
DEST_MODULE_LOCATION[0]="/kernel/drivers/video"\
BUILT_MODULE_NAME[1]="nvidia-uvm"\
DEST_MODULE_LOCATION[1]="/kernel/drivers/video"\
BUILT_MODULE_NAME[2]="nvidia-modeset"\
DEST_MODULE_LOCATION[2]="/kernel/drivers/video"\
BUILT_MODULE_NAME[3]="nvidia-drm"\
DEST_MODULE_LOCATION[3]="/kernel/drivers/video"' kernel/dkms.conf

	install -dm 755 $PKG/usr/src
	cp -dr --no-preserve='ownership' kernel $PKG/usr/src/nvidia-$version

	# blacklist conflict module
	install -d $PKG/etc/modprobe.d
	echo "blacklist nouveau" > $PKG/etc/modprobe.d/nvidia.conf
}
